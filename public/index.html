<!DOCTYPE html>
<html>
<head>
  <title>Encrypted Proxy Loader</title>
</head>
<body>
  <h1>Loadingâ€¦</h1>

  <script type="module">
    async function initWorkers() {
      // Register Service Worker
      const reg = await navigator.serviceWorker.register("/sw.js");
      console.log("[Page] Service Worker registered");

      // Wait until SW is ready
      await navigator.serviceWorker.ready;
      console.log("[Page] Service Worker ready");

      // Start SharedWorker
      const shared = new SharedWorker("/shared.js");
      shared.port.start();

      function sendPort() {
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage(
            { type: "connect-shared-worker" },
            [shared.port]
          );
          console.log("[Page] SharedWorker port sent to SW");
        }
      }

      sendPort();

      // Resend port if SW controller changes
      navigator.serviceWorker.addEventListener("controllerchange", sendPort);

      // Wait a moment to ensure SW has registered the port
      await new Promise(resolve => setTimeout(resolve, 500));

      // Reload once SW + SharedWorker ready
      if (!window.__swReloaded) {
        window.__swReloaded = true;
        console.log("[Page] Reloading now that SW is ready");
        location.reload();
      }
    }

    initWorkers().catch(err => console.error("[Page] Worker init failed:", err));
  </script>
</body>
</html>
