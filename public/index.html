<!DOCTYPE html>
<html>
<head>
  <title>Encrypted Proxy Loader</title>
</head>
<body>
  <h1>Loadingâ€¦</h1>

  <script type="module">
    async function initWorkers() {
      const reg = await navigator.serviceWorker.register("/sw.js");
      console.log("[Page] Service Worker registered");

      await navigator.serviceWorker.ready;
      console.log("[Page] Service Worker ready");

      const shared = new SharedWorker("/shared.js");
      shared.port.start();

      // Wait for handshake done message from SharedWorker
      await new Promise(resolve => {
        function onMessage(evt) {
          if (evt.data?.type === "handshake_done") {
            shared.port.removeEventListener("message", onMessage);
            resolve();
          }
        }
        shared.port.addEventListener("message", onMessage);
      });

      console.log("[Page] SharedWorker handshake done, sending port to SW");

      function sendPort() {
        if (!navigator.serviceWorker.controller) return;
        navigator.serviceWorker.controller.postMessage(
          { type: "connect-shared-worker" },
          [shared.port]
        );
        console.log("[Page] SharedWorker port sent to SW");
      }

      sendPort();
      navigator.serviceWorker.addEventListener("controllerchange", sendPort);

      // Reload once everything is ready
      if (!window.__swReloaded) {
        window.__swReloaded = true;
        console.log("[Page] Reloading now that SW + SharedWorker ready");
        location.reload();
      }
    }

    initWorkers().catch(err => console.error("[Page] Worker init failed:", err));
  </script>
</body>
</html>
