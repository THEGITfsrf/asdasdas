<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stealth WS Tunnel</title>
</head>
<body>
<h1>Stealth Tunnel</h1>

<input id="path" value="/api/hello" />
<button id="go" disabled>Fetch</button>

<pre id="out"></pre>

<script>
let ws;
const pending = new Map();

// --- WS init ---
function initWS() {
  return new Promise((resolve, reject) => {
    ws = new WebSocket("wss://asd-ywj6.onrender.com/ws");
    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
      console.log("[WS] connected");
      resolve();
    };

    ws.onerror = e => {
      console.error("[WS] error", e);
      reject(e);
    };

    ws.onmessage = ev => {
      let msg;
      try { msg = JSON.parse(ev.data); } 
      catch { return; }

      console.log("[WS] message received", msg);

      const entry = pending.get(msg.id);
      if (!entry) return;

      pending.delete(msg.id);
      entry.resolve(msg);
    };
  });
}

// --- SW messaging ---
function initProxyMessaging() {
  navigator.serviceWorker.addEventListener("message", evt => {
    console.log("[Page] SW message received", evt.data);

    if (evt.data?.type !== "proxy-fetch") return;

    const { id, req } = evt.data;
    console.log("[Page] proxy-fetch ID", id);

    pending.set(id, {
      resolve: res => {
        console.log("[Page] sending response back to SW", id);
        navigator.serviceWorker.controller.postMessage({ id, res });
      }
    });

    console.log("[Page] sending request to WS", id, req.url);

    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ id, packet: req }));
    } else {
      ws.addEventListener("open", () => {
        ws.send(JSON.stringify({ id, packet: req }));
      }, { once: true });
    }
  });
}

// --- Init ---
async function init() {
  console.log("[Page] registering SW");
  await navigator.serviceWorker.register("/sw.js");

  // Wait until the SW is ready
  await navigator.serviceWorker.ready;

  // Wait for controller (Option A)
  if (!navigator.serviceWorker.controller) {
    console.log("[Page] waiting for controllerchange");
    navigator.serviceWorker.addEventListener("controllerchange", () => {
      console.log("[Page] controller ready");
      initProxyMessaging();
    });
  } else {
    initProxyMessaging();
  }

  console.log("[Page] SW ready");

  await initWS();
  console.log("[Page] WS ready");

  document.getElementById("go").disabled = false;
}

// --- Fetch button ---
document.getElementById("go").onclick = async () => {
  const path = document.getElementById("path").value.trim();
  const out = document.getElementById("out");

  if (!path.startsWith("/")) {
    out.textContent = "Path must start with /";
    return;
  }

  out.textContent = `Fetching ${path} ...`;

  try {
    const res = await fetch(path);
    const text = await res.text();
    out.textContent = `Status: ${res.status}\n\n${text}`;
  } catch (e) {
    out.textContent = "Error: " + e;
  }
};

init().catch(e => {
  document.getElementById("out").textContent = "Init failed: " + e;
});
</script>
</body>
</html>
