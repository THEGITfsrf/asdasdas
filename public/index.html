<!DOCTYPE html>
<html>
<head>
  <title>Encrypted Proxy Loader</title>
</head>
<body>
  <h1>Loadingâ€¦</h1>

  <script type="module">
    async function initWorkers() {
      console.log("[Page] Registering Service Worker...");
      const reg = await navigator.serviceWorker.register("/sw.js");
      console.log("[Page] Service Worker registered");

      await navigator.serviceWorker.ready;
      console.log("[Page] Service Worker ready");

      // Initialize SharedWorker
      const shared = new SharedWorker("/shared.js");
      shared.port.start();

      // Wait for handshake
      await new Promise(resolve => {
        function onMessage(evt) {
          if (evt.data?.type === "handshake_done") {
            shared.port.removeEventListener("message", onMessage);
            resolve();
          }
        }
        shared.port.addEventListener("message", onMessage);
      });
      console.log("[Page] SharedWorker handshake done");

      // Send port to SW
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage(
          { type: "connect-shared-worker" },
          [shared.port]
        );
        console.log("[Page] SharedWorker port sent to SW");
      }

      // Everything ready, now load rest of the page
      console.log("[Page] All workers ready, loading app content...");
      loadApp();
    }

    function loadApp() {
      // Here you insert your real page content dynamically
      document.body.innerHTML = "<h1>App Loaded!</h1>";
      // Or you can dynamically append script tags for your app JS
    }

    initWorkers().catch(err => console.error("[Page] Worker init failed:", err));
  </script>
</body>
</html>
