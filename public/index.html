<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WS Proxy Loader</title>
</head>
<body>
  <h1>Loading…</h1>

  <button id="pingBtn" disabled>Ping /api/hello</button>
  <pre id="output"></pre>

  <script>
    let ws;
    const pending = new Map();

    // --- WebSocket init ---
    function initWS() {
      return new Promise((resolve, reject) => {
        ws = new WebSocket("wss://asd-ywj6.onrender.com/ws");
        ws.binaryType = "arraybuffer";

        ws.onopen = () => {
          console.log("[WS] connected");
          resolve();
        };

        ws.onerror = err => {
          console.error("[WS] error", err);
          reject(err);
        };

        ws.onmessage = ev => {
          let msg;
          try {
            msg = typeof ev.data === "string"
              ? JSON.parse(ev.data)
              : JSON.parse(new TextDecoder().decode(ev.data));
          } catch {
            return;
          }

          const entry = pending.get(msg.id);
          if (!entry) return;

          pending.delete(msg.id);
          entry.resolve(msg);
        };
      });
    }

    // --- Handle fetch requests from Service Worker ---
    navigator.serviceWorker.addEventListener("message", evt => {
      if (evt.data?.type !== "proxy-fetch") return;

      const { id, req } = evt.data;

      pending.set(id, {
        resolve: res => {
          navigator.serviceWorker.controller.postMessage({
            id,
            res
          });
        }
      });

      ws.send(JSON.stringify({
        id,
        url: req.url,
        method: req.method,
        headers: req.headers,
        body: req.body
      }));
    });

    // --- Init everything ---
    async function init() {
      console.log("[Page] register SW");

      await navigator.serviceWorker.register("/sw.js");
      await navigator.serviceWorker.ready;

      console.log("[Page] SW ready");

      await initWS();

      console.log("[Page] WS ready");

      document.getElementById("pingBtn").disabled = false;
      loadApp();
    }

    // --- Button action ---
    async function pingAPI() {
      const out = document.getElementById("output");
      out.textContent = "Pinging /api/hello…";

      try {
        const res = await fetch("/api/hello");
        const text = await res.text();
        out.textContent = `Status: ${res.status}\n\n${text}`;
      } catch (err) {
        out.textContent = "Error: " + err;
      }
    }

    function loadApp() {
      document.body.querySelector("#pingBtn").onclick = pingAPI;
    }

    init().catch(err => console.error("[Init failed]", err));
  </script>
</body>
</html>
